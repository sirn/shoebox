import os

import gpio
import spidev


type
  Epd2in7b* = object
    gpio*: GPIO
    spiDev*: SPIDev

  EpdPin* = enum
    epBtn1 = 5,
    epBtn2 = 6,
    epCs = 8,
    epBtn3 = 13,
    epRst = 17,
    epBtn4 = 19,
    epBusy = 24,
    epDc = 25


const
  EpdWidth* = 176
  EpdHeight* = 264


const
  PanelSetting = 0x00
  PowerSetting = 0x01
  PowerOff = 0x02
  PowerOffSequenceSetting = 0x03
  PowerOn = 0x04
  PowerOnMeasure = 0x05
  BoosterSoftStart = 0x06
  DeepSleep = 0x07
  DataStartTransmission1 = 0x10
  DataStop = 0x11
  DisplayRefresh = 0x12
  DataStartTransmission2 = 0x13
  PartialDataStartTransmission1 = 0x14
  PartialDataStartTransmission2 = 0x15
  PartialDisplayRefresh = 0x16
  LutForVcom = 0x20
  LutWhiteToWhite = 0x21
  LutBlackToWhite = 0x22
  LutWhiteToBlack = 0x23
  LutBlackToBlack = 0x24
  PllControl = 0x30
  TemperatureSensorCommand = 0x40
  TemperatureSensorCalibration = 0x41
  TemperatureSensorWrite = 0x42
  TemperatureSensorRead = 0x43
  VcomAndDataIntervalSetting = 0x50
  LowPowerDetection = 0x51
  TconSetting = 0x60
  TconResolution = 0x61
  SourceAndGateStartSetting = 0x62
  GetStatus = 0x71
  AutoMeasureVcom = 0x80
  VcomValue = 0x81
  VcmDcSettingRegister = 0x82
  ProgramMode = 0xA0
  ActiveProgram = 0xA1
  ReadOtpData = 0xA2

  LutVcomDc = [
    0x00, 0x00,
    0x00, 0x1A, 0x1A, 0x00, 0x00, 0x01,
    0x00, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x00, 0x0E, 0x01, 0x0E, 0x01, 0x10,
    0x00, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x00, 0x04, 0x10, 0x00, 0x00, 0x05,
    0x00, 0x03, 0x0E, 0x00, 0x00, 0x0A,
    0x00, 0x23, 0x00, 0x00, 0x00, 0x01
  ]

  # R21H
  LutWw = [
    0x90, 0x1A, 0x1A, 0x00, 0x00, 0x01,
    0x40, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x84, 0x0E, 0x01, 0x0E, 0x01, 0x10,
    0x80, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x00, 0x04, 0x10, 0x00, 0x00, 0x05,
    0x00, 0x03, 0x0E, 0x00, 0x00, 0x0A,
    0x00, 0x23, 0x00, 0x00, 0x00, 0x01
  ]

  # R22H    r
  LutBw = [
    0xA0, 0x1A, 0x1A, 0x00, 0x00, 0x01,
    0x00, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x84, 0x0E, 0x01, 0x0E, 0x01, 0x10,
    0x90, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0xB0, 0x04, 0x10, 0x00, 0x00, 0x05,
    0xB0, 0x03, 0x0E, 0x00, 0x00, 0x0A,
    0xC0, 0x23, 0x00, 0x00, 0x00, 0x01
  ]

  # R23H    w
  LutBb = [
    0x90, 0x1A, 0x1A, 0x00, 0x00, 0x01,
    0x40, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x84, 0x0E, 0x01, 0x0E, 0x01, 0x10,
    0x80, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x00, 0x04, 0x10, 0x00, 0x00, 0x05,
    0x00, 0x03, 0x0E, 0x00, 0x00, 0x0A,
    0x00, 0x23, 0x00, 0x00, 0x00, 0x01
  ]

  # R24H    b
  LutWb = [
    0x90, 0x1A, 0x1A, 0x00, 0x00, 0x01,
    0x20, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x84, 0x0E, 0x01, 0x0E, 0x01, 0x10,
    0x10, 0x0A, 0x0A, 0x00, 0x00, 0x08,
    0x00, 0x04, 0x10, 0x00, 0x00, 0x05,
    0x00, 0x03, 0x0E, 0x00, 0x00, 0x0A,
    0x00, 0x23, 0x00, 0x00, 0x00, 0x01
  ]


proc sendCommand(a: Epd2in7b, command: int) =
  a.gpio.write(EpdPin.epDc.int, GPIOVal.gvLow)
  a.spiDev.writeByte(byte(command))


proc sendData(a: Epd2in7b, command: int) =
  a.gpio.write(EpdPin.epDc.int, GPIOVal.gvHigh)
  a.spiDev.writeByte(byte(command))


template sendCommandWithData(a: Epd2in7b, command: int, data: varargs[int]) =
  a.sendCommand(command)
  for d in data:
    a.sendData(d)


proc wait*(a: Epd2in7b) =
  while a.gpio.read(EpdPin.epBusy.int) == GPIOVal.gvLow:
    sleep(100)


proc reset*(a: Epd2in7b) =
  a.gpio.write(EpdPin.epRst.int, GPIOVal.gvLow)
  sleep(200)
  a.gpio.write(EpdPin.epRst.int, GPIOVal.gvHigh)
  sleep(200)


proc powerOn*(a: Epd2in7b) =
  a.sendCommand(PowerOn)


proc powerOff*(a: Epd2in7b) =
  a.sendCommand(PowerOff)


proc deepSleep*(a: Epd2in7b) =
  a.sendCommand(DeepSleep)
  a.sendData(0xa5)


proc init*(a: Epd2in7b) =
  # Power on
  a.sendCommand(PowerOn)
  a.wait()

  sendCommandWithData(a, PanelSetting, 0xaf)
  sendCommandWithData(a, PllControl, 0x3a)
  sendCommandWithData(a, PowerSetting, 0x03, 0x00, 0x2b, 0x2b, 0x09)
  sendCommandWithData(a, BoosterSoftStart, 0x07, 0x07, 0x17)

  # Power optimization
  sendCommandWithData(a, 0xf8, 0x60, 0xa5)
  sendCommandWithData(a, 0xf8, 0x89, 0xa5)
  sendCommandWithData(a, 0xf8, 0x90, 0x00)
  sendCommandWithData(a, 0xf8, 0x93, 0x2a)
  sendCommandWithData(a, 0xf8, 0x73, 0x41)

  sendCommandWithData(a, VcmDcSettingRegister, 0x12)
  sendCommandWithData(a, VcomAndDataIntervalSetting, 0x87)
  sendCommandWithData(a, LutForVcom, LutVcomDc)
  sendCommandWithData(a, LutWhiteToWhite, LutWw)
  sendCommandWithData(a, LutBlackToWhite, LutBw)
  sendCommandWithData(a, LutWhiteToBlack, LutWb)
  sendCommandWithData(a, LutBlackToBlack, LutBb)
  sendCommandWithData(a, PartialDisplayRefresh, 0x00)


proc newEpd2in7b*(gpio: GPIO, spiDev: SPIDev): Epd2in7b =
  gpio.setup(EpdPin.epBtn1.int, GPIODir.gdInput, GPIOPull.gpUp)
  gpio.setup(EpdPin.epBtn2.int, GPIODir.gdInput, GPIOPull.gpUp)
  gpio.setup(EpdPin.epBtn3.int, GPIODir.gdInput, GPIOPull.gpUp)
  gpio.setup(EpdPin.epBtn4.int, GPIODir.gdInput, GPIOPull.gpUp)

  gpio.setup(EpdPin.epBusy.int, GPIODir.gdInput, GPIOPull.gpOff)
  gpio.setup(EpdPin.epRst.int, GPIODir.gdOutput, GPIOPull.gpOff)
  gpio.setup(EpdPin.epDc.int, GPIODir.gdOutput, GPIOPull.gpOff)
  gpio.setup(EpdPin.epCs.int, GPIODir.gdOutput, GPIOPull.gpOff)

  spiDev.setMaxSpeedHz(2000000)
  spiDev.setMode(0b00)

  var epd2in7b = Epd2in7b(
    gpio: gpio,
    spiDev: spiDev
  )

  epd2in7b.reset()
  epd2in7b.init()

  return epd2in7b
